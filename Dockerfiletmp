# Improved Dockerfile

ARG ROS_DISTRO=jazzy
FROM osrf/ros:${ROS_DISTRO}-desktop-full AS stage-base

LABEL maintainer="Davide Capuzzo"

ENV ROS_DISTRO=${ROS_DISTRO}
ENV DEBIAN_FRONTEND=noninteractive

SHELL ["/bin/bash", "-c"]

# ============================================================================
# STAGE 1: Base System Setup
# ============================================================================

RUN apt-get update && apt-get install -y \
    build-essential cmake git wget curl python3-pip \
    dos2unix nano vim tmux zsh \
    iputils-ping net-tools \
    supervisor tini \
    lsb-release bash-completion terminator gosu \
    libglu1-mesa-dev mesa-utils \
    locales tzdata \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update -q && \
    apt-get upgrade -y && \
    apt-get autoclean && apt-get autoremove && \
    rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 2: Graphics & VNC Setup
# ============================================================================
FROM stage-base AS stage-graphics

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    x11-xserver-utils xauth xfonts-base openbox dbus-x11 \
    libgl1 libegl1 libgl1-mesa-dri libxkbcommon-x11-0 libxcb-xinerama0 \
    libqt5gui5 libqt5widgets5 libqt5core5a libqt5x11extras5 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV QT_QPA_PLATFORM=xcb
ENV QT_X11_NO_MITSHM=1
ENV LIBGL_ALWAYS_SOFTWARE=1

# IMPROVED: Install VNC and noVNC via apt (simpler, more reliable)
RUN apt-get update && \
    apt-get install -y \
    tigervnc-standalone-server \
    novnc \
    websockify \
    tigervnc-common && \
    apt-get autoclean && apt-get autoremove && \
    rm -rf /var/lib/apt/lists/*

# IMPROVED: Create index.html symlink for easier noVNC access
RUN ln -sf /usr/share/novnc/vnc.html /usr/share/novnc/index.html

# ============================================================================
# STAGE 3: ROS2 Core Packages
# ============================================================================
FROM stage-graphics AS stage-ros2-core

RUN apt-get update && apt-get install -y \
    ros-$ROS_DISTRO-can-msgs \
    ros-$ROS_DISTRO-bondcpp \
    ros-$ROS_DISTRO-rosbag2-storage-mcap \
    nlohmann-json3-dev \
    python3-jinja2 \
    python3-typeguard \
    && rm -rf /var/lib/apt/lists/*

RUN rosdep init || true && \
    rosdep update --rosdistro ${ROS_DISTRO}

# ============================================================================
# STAGE 4: Extra ROS2 Packages
# ============================================================================
FROM stage-ros2-core AS stage-extra-ros2-packages

ARG INSTALL_PROFILE=default
# IMPROVED: Declare ROBOT_NAME here so it's available in this stage
ARG ROBOT_NAME=robot1

# IMPROVED: Better path handling - copy from build context
COPY install_robot_deps.sh /tmp/install_robot_deps.sh

RUN chmod +x /tmp/install_robot_deps.sh && \
    /tmp/install_robot_deps.sh ${INSTALL_PROFILE}

# ============================================================================
# STAGE 5: Workspace Setup
# ============================================================================
FROM stage-extra-ros2-packages AS stage-workspace

ENV USER=ubuntu
ENV HOME=/home/ubuntu
ENV ROS2_WS=$HOME/ros2_ws

RUN mkdir -p $ROS2_WS/src && \
    cd $ROS2_WS && \
    . /opt/ros/$ROS_DISTRO/setup.sh && \
    colcon build --symlink-install

# ============================================================================
# STAGE 6: Finalization
# ============================================================================
FROM stage-workspace AS stage-finalization

# IMPROVED: Re-declare ARG after FROM to make it available in this stage
ARG ROBOT_NAME=robot1

RUN apt-get autoremove -y && \
    apt-get clean -y && \
    rm -rf /var/lib/apt/lists/*

RUN rm -f /etc/apt/apt.conf.d/docker-clean

# IMPROVED: Set ROBOT_NAME as environment variable for runtime
ENV ROBOT_NAME=${ROBOT_NAME}

# IMPROVED: Copy entrypoint from build context
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh && \
    dos2unix /entrypoint.sh

# IMPROVED: Better error handling for endfunction.sh
# Try robot-specific first, fall back to default
COPY ${ROBOT_NAME}/endfunction.sh /tmp/endfunction.sh 2>/dev/null || \
     COPY default/endfunction.sh /tmp/endfunction.sh || \
     RUN echo '#!/bin/bash\necho "No endfunction.sh provided"\nsleep infinity' > /tmp/endfunction.sh

RUN chmod +x /tmp/endfunction.sh

ENTRYPOINT ["/bin/bash", "-c", "/entrypoint.sh"]

ENV USER=ubuntu
ENV PASSWD=ubuntu

# IMPROVED: Add labels for better container management
LABEL robot.name="${ROBOT_NAME}"
LABEL robot.ros_distro="${ROS_DISTRO}"
